##
## Base node image used to set up the production build
##
FROM node:12-alpine as builder
WORKDIR /usr/src/app

##
## Add all files from the current directory (if you need to ignore anything, you can use .dockerignore)
##
ADD bundle.zip .

##
## This is needed as the install state will be invalid otherwise
##
# RUN yarn install

##
## Change working directory to the workspace we want to build
##
WORKDIR bundle/packages/servers/markets

##
## Optionally run a `build` script to compile (tsc, babel, etc) the source files to /packages/backend-api/dist
##
# RUN yarn build

##
## This is our secret weapon
## Our nice plugin creates a yarn install just for us
##
# RUN yarn prod-install /usr/src/build

##
## Copy /dist directory to built image
##
# RUN cp -r dist /usr/src/build

##
## This is our actual built image
##
# FROM node:12-alpine
# WORKDIR /usr/src/app

##
## Just copy all the files generated by the builder image
##
# COPY --from=builder /usr/src/build .

##
## Expose our port and run the production app, assumes `backend-api/package.json` has a script named `start:prod`
##
EXPOSE 8080
CMD ["yarn", "start"]
